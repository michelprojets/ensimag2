#include "debug.h"
#include "string.h"
#include "cpu.h"

#include "screen_manager.h"
#include "timer.h"

void incremente_temps(){
    if (tps.sec == 59){
        tps.sec = 0;
        if (tps.min == 59){
            tps.min = 0;
            if (tps.heure == 23){
                tps.heure = 0;
            }
            else {tps.heure += 1;}
        }
        else {tps.min += 1;}
    }
    else {tps.sec += 1;}
}

// entrée table d'interruption : une ligne est sur 8 octets (4 pour l'adresse)
// entrée numéro 32 : 0x1000 + 8*32 = 0x1100
// endianness ! premier mot à l'adresse 0x1100 et le deuxième à l'adresse 0x1104

void tic_PIT(void){
    // réalise le travail concret du traitant
    outb(0x20, 0x20);

}

void config_freq_horloge(){
    // réglage du timer à une fréquence de 50 Hz
    uint16_t freq = (uint16_t)QUARTZ / (uint16_t)CLOCKFREQ;
    uint8_t low_part_freq = 0xFF & freq;
    uint8_t high_part_freq = 0xFF & (freq >> 8);
    outb(TIMER_COMMAND, NUM_PORT_TIMER_COMMAND);
    outb(low_part_freq, NUM_PORT_TIMER_DATA);
    outb(high_part_freq, NUM_PORT_TIMER_DATA);
}

void init_traitant_IT(int32_t num_IT, void (*traitant)(void)){
    return;
}

void affichage_chaine(char * chaine){
    // sauvegarde de la position corante du curseur
    outb(LOW_PART_SCR_COMMAND, NUM_PORT_SCR_COMMAND);
    uint8_t low_part_pos = inb(NUM_PORT_SCR_DATA);
    outb(HIGH_PART_SCR_COMMAND, NUM_PORT_SCR_COMMAND);
    uint8_t high_part_pos = inb(NUM_PORT_SCR_DATA);
    uint32_t pos = (high_part_pos << 8) | low_part_pos;
    uint32_t lig = pos/NB_COL_SCREEN;
    uint32_t col = pos%NB_COL_SCREEN;
    // affichage du temps en haut à droite
    place_curseur(0, NB_COL_SCREEN - 1 - NB_CAR_TEMPS);
    printf("%s", chaine);
    // replace le curseur
    place_curseur(lig, col);
}

void formatage_temps(char * str_temps, uint8_t temps){
    // construction de la chaine
    if ((0 <= temps) && (temps <= 9)){
        str_temps[0] = 0;
    }
    else {str_temps[0] = (char)(temps/10);}
    str_temps[1] = (char)(temps%10);
    str_temps[2] = '\0';
}

void construction_chaine(char * chaine){
    // ici tps vaut {0, 0, 0}
    char heure[3]; char min[3]; char sec[3];
    formatage_temps(heure, tps.heure);
    formatage_temps(min, tps.min);
    formatage_temps(sec, tps.sec);
    sprintf(chaine, "%s:%s:%s", heure, min, sec);
}
